---
tags: 
  - Go
  - SSA
  - 编译器
title: Go 编译器 SSA 中间代码探究
date: 2021-02-01
author: 徐徐
location: Beijing
---

## 环境

* Go 版本：1.15.6

## 起因

前一段时间，在某个 Go 交流学习群里有一个群友发出下面两段特殊的代码：

代码段 1 ：

```go
package main

import "time"

func main() {
	var i = 1
	go func() {
		time.Sleep(1*time.Second)
		println(i)
	}()
	i = 2
	for  {
	}
}
```

代码段 2 ：

```go
package main

import "time"

func main() {
	var i = 1
	go func() {
		time.Sleep(1*time.Second)
		println(i)
	}()
	i = 2
	select  {
	}
}
```

这两段程序的输出是什么？大部分人可能会觉得这两个程序会输出 2，毕竟 goroutine 在等待 1 秒钟之后才会输出 i 的值，这个时候 i = 2 这一行肯定已经执行了。但是事实是，这两段代码输出的结果不相同，代码段 1 输出的是 1，代码段 2 输出的是 2。这两段代码唯一的区别就是最后的部分，一个是 for，一个是 select，两者都会造成程序最终阻塞。

排查这个问题最容易想到的方式就是先看一下这段代码编译之后的汇编。

## 汇编代码

执行如下命令查看两者的汇编代码：

```sh
go tool compile  -S main.go
```

这里只截取代码段 1 的部分汇编：

```go
0x0024 00036 (main.go:6)        LEAQ    type.int(SB), AX
0x002b 00043 (main.go:6)        MOVQ    AX, (SP)
0x002f 00047 (main.go:6)        PCDATA  $1, $0
0x002f 00047 (main.go:6)        CALL    runtime.newobject(SB)
0x0034 00052 (main.go:6)        MOVQ    8(SP), AX
0x0039 00057 (main.go:6)        MOVQ    $1, (AX)
0x0040 00064 (main.go:7)        MOVL    $8, (SP)
0x0047 00071 (main.go:7)        LEAQ    "".main.func1·f(SB), CX
0x004e 00078 (main.go:7)        MOVQ    CX, 8(SP)
0x0053 00083 (main.go:7)        MOVQ    AX, 16(SP)
0x0058 00088 (main.go:7)        CALL    runtime.newproc(SB)
0x005d 00093 (main.go:12)       PCDATA  $1, $-1
0x005d 00093 (main.go:12)       XCHGL   AX, AX
0x005e 00094 (main.go:12)       NOP

```

可以看到，第 11 行已经被编译器优化掉了，所以代码 1 执行的结果是 1，而代码段 2 并没有被优化。

## 编译器优化部分：SSA 中间代码的生成与优化

SSA 叫做静态单赋值形式，是一种中间代码的表现形式，Go 的源代码在解析成 AST 之后，并不会直接生成目标机器代码，而是先转换成 SSA 形式的中间代码，
然后通过对中间代码一系列的优化，最终才会生成目标机器码。也是我们常说的编译器前端的组成部分，也是前端处理源码的最后一步。

> 基于一个适当定义的中间表示形式，可以把针对源语言 i 的前端和针对目标机器 j 的后端组合起来，构造得到源语言 i 在目标机器 j 上的一个编译器。这种创建编译器组合
> 的方法可以大大减少工作量：只要写出 m 种前段和 n 种后端处理程序，就可以得到 m*n 种编译程序。
>\
>\
>*《编译原理》第六章 中间代码的生成*

## 其他细节

* 调试工具：dlv
* 调试 Go 编译器的时候，需要重新编译 Go 的编译器，直接安装的二进制 Go 可能没有调试信息，造成无法调试。

## 参考资料

* [https://draveness.me/golang/docs/part1-prerequisite/ch02-compile/golang-ir-ssa/](https://draveness.me/golang/docs/part1-prerequisite/ch02-compile/golang-ir-ssa/)
