---
tags: 
  - ESP8266
  - 单片机
title: 新玩具：ESP8266
date: 2021-02-23
author: 徐徐
location: Beijing 
---

前一段时间突发奇想想做一个硬件。

需求是这样的：在老家一般太阳能加水都是使用水泵抽到房顶，当水满的时候，关掉水泵的电源。
这样其实显得不够自动化，每次还要人看着，如果有一个硬件能控制，那可真是太棒了，哈哈。从硬件的实现角度来讲也很简单：就是通过水位的变化控制水泵的开关。

**注意，接下来的硬件会涉及到继电器，:warning:高压危险:warning:，所以非专业人员还是不要尝试了！**

## 硬件选型

作为一名软件工程师，从来没有研究过嵌入式领域。一开始想到的就是非常出名的树莓派，但是成本比较高，而且有点杀鸡用牛刀的感觉。

经过一番探索，一个物美价廉的产品出现：[**ESP8266**](https://www.espressif.com/zh-hans/products/socs/esp8266)。这个小东西十几块钱就能从某宝上买到，而且还是一块带有 WIFI 功能的 [MCU](https://en.wikipedia.org/wiki/Microcontroller)。
由我国的乐鑫科技设计。

![esp8266](./img/esp8266.jpg)

ESP8266 只是芯片的名称，我们买到的基本上都是一块设计好的开发板，有开发用的引脚，还有已经集成好的和开发计算机交互用的串口芯片等等。

当然如果会 PCB 设计，也可以自己设计，把需要的元器件、传感器设计到一个 PCB 上，这样就不需要使用线材连接传感器到这种通用开发板，显得不是很优雅。

聊到开发板，就不得不提 [Arduino](https://www.arduino.cc/)。Arduino 是一个开源的电子原型平台，包括各种型号的 Arduino 的开发板、嵌入式开发用的 Arduino IDE。
通过 Arduino IDE ，可以很方便的和各种传感器交互（库很丰富，而且 Arduino 环境对硬件抽象的也很好）。不过 Arduino 的开发板比 ESP8266 十几块的价格贵，幸运的是 ESP8266 也支持在 Arduino 环境下开发。
接下来的开发也都是在这个环境下。

最终本次需求的硬件是：

* 水位传感器（Water Sensor）
* 继电器
* 升压模块（继电器工作电压是 5v，ESP8266 供电引脚为 3.3v）
* ESP8266 开发板
* 连接线
* 万用表（测试电路通断，测量升压模块输出电压）

当然为了玩，还买了其他的传感器，例如温湿度传感器、单色 LCD 显示器、蜂鸣器等。

## 预备

在准备为芯片编程之前，还是需要了解一些嵌入式开发的预备知识。
先上一张开发板的引脚图：

![esp8266-gpio](./img/esp8266-gpio-pin.png)

图中的引脚 `3.3v`、`GND`（负极）是供电引脚，为传感器供电，有一些传感器要求是 5v，这个时候就要连接升压模块才能使传感器正常工作。
我们将开发板的引脚和传感器的引脚使用线材相连，为了方便，也可以使用面包板。

引脚中最多的就是 [GPIO](https://zh.wikipedia.org/wiki/GPIO) 了，可以通过这个引脚接收和输入数据（电位高低）和传感器交互。GPIO 接收的是数字信号，也就是 0 或者 1，左上角的 ADC0 引脚可以接收模拟信号，取值范围为 0 ~ 1023。

![esp8266-line](./img/esp8266-line.jpg)

## 开发环境

开发环境使用 Arduino 环境，网上可以很容易找到 ESP8266 的配置，这里就不在介绍了，打开 Arduino IDE，将开发板和电脑通过 USB 相连，就可以就行开发了。

这里额外说一下，要想电脑识别到开发板，需要安装对应开发板串口芯片的驱动才行，买的时候商品上面有标识，如果没有的话可以看一下
Micro USB 接口附近的芯片，一般靠近最大的就是，我的芯片是 CH340，直接 Google 关键词就可以找到驱动了。

## 编码

Arduino 对硬件的抽象非常简单，我们只要使用 C 语言对两个函数编程就可以了。一个是初始化函数 setup，在硬件上电或者重置的时候运行一次，这个函数内可以进行连接 WIFI，启动一个精简的 web 服务器等等操作。另外的 loop 函数相当于 main 函数，只不过这个函数会被无限循环调用，这个函数编写主逻辑。

```c
void setup() {
  // put your setup code here, to run once:
}

void loop() {
  // put your main code here, to run repeatedly:
}
```
